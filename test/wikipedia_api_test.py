'''
Created on May 26, 2013

@author: cda
'''
import unittest
import json
from parser.wikipedia import WikipediaApiParser, WikipediaLoader
from site.wikipedia import find_links_in_text

class WikipediaLoaderTest(unittest.TestCase):

    def a_main_page(self):
        loader = WikipediaLoader()
        loader.json_fetch = lambda title:json.loads(r"""{"query":{"pages":{"15580374":{"pageid":15580374,"ns":0,"title":"Wikipedia:Hauptseite","revisions":[{"contentformat":"text/x-wiki","contentmodel":"wikitext","*":"<!--        BANNER ACROSS TOP OF PAGE        -->\n{| id=\"mp-topbanner\" style=\"width:100%; background:#f9f9f9; margin:1.2em 0 6px 0; border:1px solid #ddd;\"\n| style=\"width:61%; color:#000;\" |\n<!--        \"WELCOME TO WIKIPEDIA\" AND ARTICLE COUNT        -->\n{| style=\"width:280px; border:none; background:none;\"\n| style=\"width:280px; text-align:center; white-space:nowrap; color:#000;\" |\n<div style=\"font-size:162%; border:none; margin:0; padding:.1em; color:#000;\">Welcome to [[Wikipedia]],</div>\n<div style=\"top:+0.2em; font-size:95%;\">the [[free content|free]] [[encyclopedia]] that [[Wikipedia:Introduction|anyone can edit]].</div>\n<div id=\"articlecount\" style=\"font-size:85%;\">[[Special:Statistics|{{NUMBEROFARTICLES}}]] articles in [[English language|English]]</div>\n|}\n<!--        PORTAL LIST ON RIGHT-HAND SIDE        -->\n| style=\"width:13%; font-size:95%;\" |\n* [[Portal:Arts|Arts]]\n* [[Portal:Biography|Biography]]\n* [[Portal:Geography|Geography]]\n| style=\"width:13%; font-size:95%;\" |\n* [[Portal:History|History]]\n* [[Portal:Mathematics|Mathematics]]\n* [[Portal:Science|Science]]\n| style=\"width:13%; font-size:95%;\" |\n* [[Portal:Society|Society]]\n* [[Portal:Technology|Technology]]\n* '''[[Portal:Contents/Portals|All portals]]'''\n|}\n<!--        MAIN PAGE BANNER        -->\n{{#if:{{Main Page banner}}|\n<table id=\"mp-banner\" style=\"width: 100%; margin:4px 0 0 0; background:none; border-spacing: 0px;\">\n<tr><td class=\"MainPageBG\" style=\"text-align:center; padding:0.2em; background-color:#fffaf5; border:1px solid #f2e0ce; color:#000; font-size:100%;\">{{Main Page banner}}\n</td></tr>\n</table>\n}}\n<!--        TODAY'S FEATURED CONTENT        -->\n{| id=\"mp-upper\" style=\"width: 100%; margin:4px 0 0 0; background:none; border-spacing: 0px;\"\n<!--        TODAY'S FEATURED ARTICLE; DID YOU KNOW        -->\n| class=\"MainPageBG\" style=\"width:55%; border:1px solid #cef2e0; background:#f5fffa; vertical-align:top; color:#000;\" |\n{| id=\"mp-left\" style=\"width:100%; vertical-align:top; background:#f5fffa;\"\n| style=\"padding:2px;\" | <h2 id=\"mp-tfa-h2\" style=\"margin:3px; background:#cef2e0; font-size:120%; font-weight:bold; border:1px solid #a3bfb1; text-align:left; color:#000; padding:0.2em 0.4em;\">{{#ifexpr:{{formatnum:{{PAGESIZE:Wikipedia:Today's featured article/{{#time:F j, Y}}}}|R}}>150|From today's featured article|Featured article <span style=\"font-size:85%; font-weight:normal;\">(Check back later for today's.)</span>}}</h2>\n|-\n| style=\"color:#000;\" | <div id=\"mp-tfa\" style=\"padding:2px 5px\">{{#ifexpr:{{formatnum:{{PAGESIZE:Wikipedia:Today's featured article/{{#time:F j, Y}}}}|R}}>150|{{Wikipedia:Today's featured article/{{#time:F j, Y}}}}|{{Wikipedia:Today's featured article/{{#time:F j, Y|-1 day}}}}}}</div>\n|-\n| style=\"padding:2px;\" | <h2 id=\"mp-dyk-h2\" style=\"margin:3px; background:#cef2e0; font-size:120%; font-weight:bold; border:1px solid #a3bfb1; text-align:left; color:#000; padding:0.2em 0.4em;\">Did you know...</h2>\n|-\n| style=\"color:#000; padding:2px 5px 5px;\" | <div id=\"mp-dyk\">{{Did you know}}</div>\n|}\n| style=\"border:1px solid transparent;\" |\n<!--        IN THE NEWS; ON THIS DAY        -->\n| class=\"MainPageBG\" style=\"width:45%; border:1px solid #cedff2; background:#f5faff; vertical-align:top;\"|\n{| id=\"mp-right\" style=\"width:100%; vertical-align:top; background:#f5faff;\"\n| style=\"padding:2px;\" | <h2 id=\"mp-itn-h2\" style=\"margin:3px; background:#cedff2; font-size:120%; font-weight:bold; border:1px solid #a3b0bf; text-align:left; color:#000; padding:0.2em 0.4em;\">In the news</h2>\n|-\n| style=\"color:#000; padding:2px 5px;\" | <div id=\"mp-itn\">{{In the news}}</div>\n|-\n| style=\"padding:2px;\" | <h2 id=\"mp-otd-h2\" style=\"margin:3px; background:#cedff2; font-size:120%; font-weight:bold; border:1px solid #a3b0bf; text-align:left; color:#000; padding:0.2em 0.4em;\">On this day...</h2>\n|-\n| style=\"color:#000; padding:2px 5px 5px;\" | <div id=\"mp-otd\">{{Wikipedia:Selected anniversaries/{{#time:F j}}}}</div>\n|}\n|}\n<!--        TODAY'S FEATURED LIST        --><!-- CONDITIONAL: SHOW/HIDE FROM HERE -->{{#switch:{{CURRENTDAYNAME}}|Monday=\n<table id=\"mp-middle\" style=\"width:100%; margin:4px 0 0 0; background:none; border-spacing: 0px;\">\n<tr>\n<td class=\"MainPageBG\" style=\"width:100%; border:1px solid #f2cedd; background:#fff5fa; vertical-align:top; color:#000;\">\n<table id=\"mp-center\" style=\"width:100%; vertical-align:top; background:#fff5fa; color:#000;\">\n<tr>\n<td style=\"padding:2px;\"><h2 id=\"mp-tfl-h2\" style=\"margin:3px; background:#f2cedd; font-size:120%; font-weight:bold; border:1px solid #bfa3af; text-align:left; color:#000; padding:0.2em 0.4em\">From today's featured list</h2></td>\n</tr><tr>\n<td style=\"color:#000;\"><div id=\"mp-tfl\" style=\"padding:2px 5px;\">{{#ifexist:Wikipedia:Today's featured list/{{#time:F j, Y}}|{{Wikipedia:Today's featured list/{{#time:F j, Y}}}}|{{TFLempty}}}}</div></td>\n</tr>\n</table>\n</td>\n</tr>\n</table>\n<!--        END TODAY'S FEATURED LIST        --><!-- CONDITIONAL: SHOW/HIDE TO HERE -->|}}\n<!--        TODAY'S FEATURED PICTURE        -->\n{| id=\"mp-lower\" style=\"margin:4px 0 0 0; width:100%; background:none; border-spacing: 0px;\"\n| class=\"MainPageBG\" style=\"width:100%; border:1px solid #ddcef2; background:#faf5ff; vertical-align:top; color:#000;\" |\n{| id=\"mp-bottom\" style=\"width:100%; vertical-align:top; background:#faf5ff; color:#000;\"\n| style=\"padding:2px;\" | <h2 id=\"mp-tfp-h2\" style=\"margin:3px; background:#ddcef2; font-size:120%; font-weight:bold; border:1px solid #afa3bf; text-align:left; color:#000; padding:0.2em 0.4em\">{{#ifexist:Template:POTD protected/{{#time:Y-m-d}}|Today's featured picture | Featured picture&ensp;<span style=\"font-size:85%; font-weight:normal;\">(Check back later for today's.)</span>}}</h2>\n|-\n| style=\"color:#000; padding:2px;\" | <div id=\"mp-tfp\">{{#ifexist:Template:POTD protected/{{#time:Y-m-d}}|{{POTD protected/{{#time:Y-m-d}}}}|{{POTD protected/{{#time:Y-m-d|-1 day}}}}}}</div>\n|}\n|}\n<!--        SECTIONS AT BOTTOM OF PAGE        -->\n<div id=\"mp-other\" style=\"padding-top:4px; padding-bottom:2px;\">\n== Other areas of Wikipedia ==\n{{Other areas of Wikipedia}}\n</div><div id=\"mp-sister\">\n== Wikipedia's sister projects ==\n{{Wikipedia's sister projects}}\n</div><div id=\"mp-lang\">\n== Wikipedia languages ==\n{{Wikipedia languages}}\n</div>\n<!--        INTERWIKI STRAPLINE        -->\n<noinclude>{{Main Page interwikis}}{{noexternallanglinks}}</noinclude>__NOTOC____NOEDITSECTION__"}]}}}}""")
        site = loader.load_site_by_title('Wikipedia:Hauptseite')
        return site

    def test_load_main_page(self):
        site = self.a_main_page()
        self.assertEquals('Wikipedia:Hauptseite', site.title)

    def test_will_parse_links_from_page(self):
        site = self.a_main_page()
        self.assertEquals(15, len(site.links))
        self.assertEquals(15, len(filter(lambda link : link.source == site, site.links)))

class WikipediaApiParserTest(unittest.TestCase):
    
    def test_load_wikipedia_site(self):
        json_object = json.loads(r"""{"query":{"pages":{"15580374":{"pageid":15580374,"ns":0,"title":"Main Page","revisions":[{"contentformat":"text/x-wiki","contentmodel":"wikitext","*":"<!--        BANNER ACROSS TOP OF PAGE        -->\n{| id=\"mp-topbanner\" style=\"width:100%; background:#f9f9f9; margin:1.2em 0 6px 0; border:1px solid #ddd;\"\n| style=\"width:61%; color:#000;\" |\n<!--        \"WELCOME TO WIKIPEDIA\" AND ARTICLE COUNT        -->\n{| style=\"width:280px; border:none; background:none;\"\n| style=\"width:280px; text-align:center; white-space:nowrap; color:#000;\" |\n<div style=\"font-size:162%; border:none; margin:0; padding:.1em; color:#000;\">Welcome to [[Wikipedia]],</div>\n<div style=\"top:+0.2em; font-size:95%;\">the [[free content|free]] [[encyclopedia]] that [[Wikipedia:Introduction|anyone can edit]].</div>\n<div id=\"articlecount\" style=\"font-size:85%;\">[[Special:Statistics|{{NUMBEROFARTICLES}}]] articles in [[English language|English]]</div>\n|}\n<!--        PORTAL LIST ON RIGHT-HAND SIDE        -->\n| style=\"width:13%; font-size:95%;\" |\n* [[Portal:Arts|Arts]]\n* [[Portal:Biography|Biography]]\n* [[Portal:Geography|Geography]]\n| style=\"width:13%; font-size:95%;\" |\n* [[Portal:History|History]]\n* [[Portal:Mathematics|Mathematics]]\n* [[Portal:Science|Science]]\n| style=\"width:13%; font-size:95%;\" |\n* [[Portal:Society|Society]]\n* [[Portal:Technology|Technology]]\n* '''[[Portal:Contents/Portals|All portals]]'''\n|}\n<!--        MAIN PAGE BANNER        -->\n{{#if:{{Main Page banner}}|\n<table id=\"mp-banner\" style=\"width: 100%; margin:4px 0 0 0; background:none; border-spacing: 0px;\">\n<tr><td class=\"MainPageBG\" style=\"text-align:center; padding:0.2em; background-color:#fffaf5; border:1px solid #f2e0ce; color:#000; font-size:100%;\">{{Main Page banner}}\n</td></tr>\n</table>\n}}\n<!--        TODAY'S FEATURED CONTENT        -->\n{| id=\"mp-upper\" style=\"width: 100%; margin:4px 0 0 0; background:none; border-spacing: 0px;\"\n<!--        TODAY'S FEATURED ARTICLE; DID YOU KNOW        -->\n| class=\"MainPageBG\" style=\"width:55%; border:1px solid #cef2e0; background:#f5fffa; vertical-align:top; color:#000;\" |\n{| id=\"mp-left\" style=\"width:100%; vertical-align:top; background:#f5fffa;\"\n| style=\"padding:2px;\" | <h2 id=\"mp-tfa-h2\" style=\"margin:3px; background:#cef2e0; font-size:120%; font-weight:bold; border:1px solid #a3bfb1; text-align:left; color:#000; padding:0.2em 0.4em;\">{{#ifexpr:{{formatnum:{{PAGESIZE:Wikipedia:Today's featured article/{{#time:F j, Y}}}}|R}}>150|From today's featured article|Featured article <span style=\"font-size:85%; font-weight:normal;\">(Check back later for today's.)</span>}}</h2>\n|-\n| style=\"color:#000;\" | <div id=\"mp-tfa\" style=\"padding:2px 5px\">{{#ifexpr:{{formatnum:{{PAGESIZE:Wikipedia:Today's featured article/{{#time:F j, Y}}}}|R}}>150|{{Wikipedia:Today's featured article/{{#time:F j, Y}}}}|{{Wikipedia:Today's featured article/{{#time:F j, Y|-1 day}}}}}}</div>\n|-\n| style=\"padding:2px;\" | <h2 id=\"mp-dyk-h2\" style=\"margin:3px; background:#cef2e0; font-size:120%; font-weight:bold; border:1px solid #a3bfb1; text-align:left; color:#000; padding:0.2em 0.4em;\">Did you know...</h2>\n|-\n| style=\"color:#000; padding:2px 5px 5px;\" | <div id=\"mp-dyk\">{{Did you know}}</div>\n|}\n| style=\"border:1px solid transparent;\" |\n<!--        IN THE NEWS; ON THIS DAY        -->\n| class=\"MainPageBG\" style=\"width:45%; border:1px solid #cedff2; background:#f5faff; vertical-align:top;\"|\n{| id=\"mp-right\" style=\"width:100%; vertical-align:top; background:#f5faff;\"\n| style=\"padding:2px;\" | <h2 id=\"mp-itn-h2\" style=\"margin:3px; background:#cedff2; font-size:120%; font-weight:bold; border:1px solid #a3b0bf; text-align:left; color:#000; padding:0.2em 0.4em;\">In the news</h2>\n|-\n| style=\"color:#000; padding:2px 5px;\" | <div id=\"mp-itn\">{{In the news}}</div>\n|-\n| style=\"padding:2px;\" | <h2 id=\"mp-otd-h2\" style=\"margin:3px; background:#cedff2; font-size:120%; font-weight:bold; border:1px solid #a3b0bf; text-align:left; color:#000; padding:0.2em 0.4em;\">On this day...</h2>\n|-\n| style=\"color:#000; padding:2px 5px 5px;\" | <div id=\"mp-otd\">{{Wikipedia:Selected anniversaries/{{#time:F j}}}}</div>\n|}\n|}\n<!--        TODAY'S FEATURED LIST        --><!-- CONDITIONAL: SHOW/HIDE FROM HERE -->{{#switch:{{CURRENTDAYNAME}}|Monday=\n<table id=\"mp-middle\" style=\"width:100%; margin:4px 0 0 0; background:none; border-spacing: 0px;\">\n<tr>\n<td class=\"MainPageBG\" style=\"width:100%; border:1px solid #f2cedd; background:#fff5fa; vertical-align:top; color:#000;\">\n<table id=\"mp-center\" style=\"width:100%; vertical-align:top; background:#fff5fa; color:#000;\">\n<tr>\n<td style=\"padding:2px;\"><h2 id=\"mp-tfl-h2\" style=\"margin:3px; background:#f2cedd; font-size:120%; font-weight:bold; border:1px solid #bfa3af; text-align:left; color:#000; padding:0.2em 0.4em\">From today's featured list</h2></td>\n</tr><tr>\n<td style=\"color:#000;\"><div id=\"mp-tfl\" style=\"padding:2px 5px;\">{{#ifexist:Wikipedia:Today's featured list/{{#time:F j, Y}}|{{Wikipedia:Today's featured list/{{#time:F j, Y}}}}|{{TFLempty}}}}</div></td>\n</tr>\n</table>\n</td>\n</tr>\n</table>\n<!--        END TODAY'S FEATURED LIST        --><!-- CONDITIONAL: SHOW/HIDE TO HERE -->|}}\n<!--        TODAY'S FEATURED PICTURE        -->\n{| id=\"mp-lower\" style=\"margin:4px 0 0 0; width:100%; background:none; border-spacing: 0px;\"\n| class=\"MainPageBG\" style=\"width:100%; border:1px solid #ddcef2; background:#faf5ff; vertical-align:top; color:#000;\" |\n{| id=\"mp-bottom\" style=\"width:100%; vertical-align:top; background:#faf5ff; color:#000;\"\n| style=\"padding:2px;\" | <h2 id=\"mp-tfp-h2\" style=\"margin:3px; background:#ddcef2; font-size:120%; font-weight:bold; border:1px solid #afa3bf; text-align:left; color:#000; padding:0.2em 0.4em\">{{#ifexist:Template:POTD protected/{{#time:Y-m-d}}|Today's featured picture | Featured picture&ensp;<span style=\"font-size:85%; font-weight:normal;\">(Check back later for today's.)</span>}}</h2>\n|-\n| style=\"color:#000; padding:2px;\" | <div id=\"mp-tfp\">{{#ifexist:Template:POTD protected/{{#time:Y-m-d}}|{{POTD protected/{{#time:Y-m-d}}}}|{{POTD protected/{{#time:Y-m-d|-1 day}}}}}}</div>\n|}\n|}\n<!--        SECTIONS AT BOTTOM OF PAGE        -->\n<div id=\"mp-other\" style=\"padding-top:4px; padding-bottom:2px;\">\n== Other areas of Wikipedia ==\n{{Other areas of Wikipedia}}\n</div><div id=\"mp-sister\">\n== Wikipedia's sister projects ==\n{{Wikipedia's sister projects}}\n</div><div id=\"mp-lang\">\n== Wikipedia languages ==\n{{Wikipedia languages}}\n</div>\n<!--        INTERWIKI STRAPLINE        -->\n<noinclude>{{Main Page interwikis}}{{noexternallanglinks}}</noinclude>__NOTOC____NOEDITSECTION__"}]}}}}""")
        site = WikipediaApiParser().parse_site_from_json(json_object)
        self.assertEquals('Main Page', site.title)
 

class WikimarkupParserTest(unittest.TestCase):
    
    def test_will_be_recognized_as_link(self):
        texts = ['Link', 'other Link', 'otherLink', 'Streichholz']
        
        for text in texts:
            self.assertEquals((text, ), find_links_in_text('[[' + text + ']]'))

    def test_file_will_be_recognized_as_link(self):
        text = '[[Datei:File.jpg]]'
        self.assertEquals(('Datei:File.jpg', ), find_links_in_text(text))
        
    def test_will_recognize_all_links(self):
        text = 'This is a text with a [[link]]'
        self.assertEquals(('link',), find_links_in_text(text))
        
    def test_find_all_links_in_text(self):
        text = """<!-- BANNER ACROSS TOP OF PAGE --> {| id="mp-topbanner" style="width:100%; background:#f9f9f9; margin:1.2em 0 6px 0; border:1px solid #ddd;" | style="width:61%; color:#000;" | <!-- "WELCOME TO WIKIPEDIA" AND ARTICLE COUNT --> {| style="width:280px; border:none; background:none;" | style="width:280px; text-align:center; white-space:nowrap; color:#000;" | <div style="font-size:162%; border:none; margin:0; padding:.1em; color:#000;">Welcome to [[Wikipedia]],</div> <div style="top:+0.2em; font-size:95%;">the [[free content|free]] [[encyclopedia]] that [[Wikipedia:Introduction|anyone can edit]].</div> <div id="articlecount" style="font-size:85%;">[[Special:Statistics|{{NUMBEROFARTICLES}}]] articles in [[English language|English]]</div> |} <!-- PORTAL LIST ON RIGHT-HAND SIDE --> | style="width:13%; font-size:95%;" | * [[Portal:Arts|Arts]] * [[Portal:Biography|Biography]] * [[Portal:Geography|Geography]] | style="width:13%; font-size:95%;" | * [[Portal:History|History]] * [[Portal:Mathematics|Mathematics]] * [[Portal:Science|Science]] | style="width:13%; font-size:95%;" | * [[Portal:Society|Society]] * [[Portal:Technology|Technology]] * '''[[Portal:Contents/Portals|All portals]]''' |}"""
        self.assertEquals(('Wikipedia',
 'free content|free',
 'encyclopedia',
 'Wikipedia:Introduction|anyone can edit',
 'Special:Statistics|{{NUMBEROFARTICLES}}',
 'English language|English',
 'Portal:Arts|Arts',
 'Portal:Biography|Biography',
 'Portal:Geography|Geography',
 'Portal:History|History',
 'Portal:Mathematics|Mathematics',
 'Portal:Science|Science',
 'Portal:Society|Society',
 'Portal:Technology|Technology',
 'Portal:Contents/Portals|All portals'), find_links_in_text(text))
        

if __name__ == "__main__":
    unittest.main()